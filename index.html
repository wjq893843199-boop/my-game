<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="data:;base64,=">
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
    <title>å¦™æ¢å¯»å‡¶ - æ¢æ¡ˆé›†</title>
    <style>
        :root {
            --bg-paper: #fdfbf7;
            --ink-color: #2c3e50;
            --border-color: #333;
            --grid-line: #999;
            --card-bg: #fff;
            --accent-red: #c0392b;
            --accent-green: #27ae60;
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
            
            /* --- ä¿®æ”¹ç‚¹ï¼šè®°äº‹æœ¬èƒŒæ™¯çº¹ç† --- */
            background-color: var(--bg-paper);
            background-image: 
                linear-gradient(#e1e8ed 1px, transparent 1px), /* æ·¡æ·¡çš„æ¨ªçº¿ */
                linear-gradient(90deg, #e1e8ed 1px, transparent 1px); /* æ·¡æ·¡çš„ç«–çº¿(ç½‘æ ¼) */
            background-size: 20px 20px; /* æ ¼å­å¤§å° */
            /* --------------------------- */
            
            color: var(--ink-color);
            margin: 0;
            padding: 10px 15px 50px;
            line-height: 1.6;
        }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* å¯¼èˆªæ  */
        .nav-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: #eee; padding: 10px; border-radius: 8px; margin-bottom: 20px; border: 2px solid var(--ink-color);
        }
        .nav-btn { background: var(--ink-color); color: #fff; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; opacity: 1; transition: opacity 0.3s; }
        .nav-btn:disabled { background: #999; cursor: not-allowed; opacity: 0.6; }
        .case-title { font-weight: 900; font-size: 1.1rem; text-transform: uppercase; }

        /* --- æ ‡é¢˜åŒºåŸŸ (åŒ…å«æ™ºèƒ½å¼€å…³) --- */
        header {
            border-bottom: 3px solid var(--ink-color); margin-bottom: 20px; padding-bottom: 10px;
            display: flex; align-items: center; justify-content: space-between; /* ä¸¤ç«¯å¯¹é½ */
            flex-wrap: wrap; gap: 10px;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        
        h1 { margin: 0; font-size: 1.4rem; font-weight: 900; }
        #diff-tag {
            font-size: 0.75rem; border: 1px solid var(--ink-color); padding: 2px 8px;
            border-radius: 12px; background-color: rgba(0,0,0,0.05); font-weight: bold;
            color: #555; white-space: nowrap; transform: translateY(2px); 
        }

        /* --- æ™ºèƒ½æ¨¡å¼å¼€å…³æ ·å¼ --- */
        .smart-mode-control {
            display: flex; align-items: center; gap: 8px; font-size: 0.9rem; font-weight: bold;
        }
        
        /* é—®å·æç¤ºå›¾æ ‡ */
        .tooltip-icon {
            display: inline-block; width: 18px; height: 18px; line-height: 18px;
            background: #999; color: #fff; border-radius: 50%; text-align: center;
            font-size: 12px; cursor: help; position: relative;
        }
        
        /* æç¤ºæ–‡å­—æ°”æ³¡ */
        .tooltip-icon .tooltip-text {
            visibility: hidden; width: 250px; background-color: #333; color: #fff;
            text-align: left; border-radius: 6px; padding: 10px; position: absolute;
            z-index: 10; top: 120%; right: 0; font-size: 0.8rem; font-weight: normal;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s;
            line-height: 1.4;
        }
        .tooltip-icon:hover .tooltip-text { visibility: visible; opacity: 1; }
        
        /* æ»‘å—å¼€å…³ (Toggle Switch) */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #c0392b; /* åˆå§‹çº¢è‰² */
            transition: .4s; border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px;
            left: 3px; bottom: 3px; background-color: white;
            transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #27ae60; /* æ¿€æ´»ç»¿è‰² */ }
        input:checked + .slider:before { transform: translateX(20px); }


        /* ç®€ä»‹ */
        .intro-box { background: #fff; padding: 15px; border-radius: 6px; margin-bottom: 30px; font-size: 0.95rem; border: 1px solid #ccc; color: #444; box-shadow: 2px 2px 0 rgba(0,0,0,0.05); }
        .section-label { font-weight: bold; font-size: 1.1rem; border-bottom: 2px solid var(--ink-color); margin: 30px 0 15px; padding-bottom: 5px; }
        
        /* ä¾¦æ¢ç¬”è®°å¤´éƒ¨ */
        .notes-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--ink-color); margin: 0 0 10px 0; padding-bottom: 5px;
        }
        .notes-title { font-weight: bold; font-size: 1.1rem; }
        .btn-reset-board {
            font-size: 0.8rem; padding: 4px 12px; border: 1px solid var(--ink-color);
            background: #fff; color: #555; border-radius: 15px; cursor: pointer;
            transition: background 0.2s; display: flex; align-items: center; gap: 4px;
        }
        .btn-reset-board:hover { background: #eee; color: #000; }
        
        /* å¡ç‰‡ */
        .cards-list { display: flex; flex-direction: column; gap: 15px; }
        .suspect-card { border: 2px solid var(--border-color); border-radius: 12px; padding: 12px; background: var(--card-bg); display: flex; align-items: center; gap: 15px; }
        .sus-icon-box { display: flex; flex-direction: column; align-items: center; min-width: 80px; }
        .sus-icon { font-size: 3rem; filter: grayscale(100%); line-height: 1; }
        .sus-name-short { font-size: 0.7rem; font-weight: bold; margin-top: 5px; text-align: center; }
        .sus-info { flex: 1; }
        .sus-desc { font-size: 0.9rem; margin-bottom: 8px; }
        .sus-traits { font-size: 0.8rem; font-weight: 800; color: #000; }
        
        .grid-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 10px; }
        .item-card { border: 2px solid var(--border-color); border-radius: 10px; padding: 10px 5px; background: var(--card-bg); text-align: center; display: flex; flex-direction: column; align-items: center; }
        .item-icon { font-size: 2.2rem; filter: grayscale(100%); margin-bottom: 5px; }
        .item-name { font-weight: bold; font-size: 0.9rem; margin-bottom: 2px; line-height: 1.2;}
        .item-tag { font-size: 0.7rem; color: #666; margin-bottom: 5px; font-weight: bold;}
        .item-desc { font-size: 0.75rem; color: #444; line-height: 1.3; text-align: center; width: 100%; padding: 0 4px;}
        
        .clues-box { background: #fff; border: 2px dashed var(--border-color); padding: 20px; border-radius: 6px; margin: 30px 0; }
        .clue-item { margin-bottom: 8px; padding-left: 15px; position: relative; font-size: 0.95rem; }
        .clue-item::before { content: 'â€¢'; position: absolute; left: 0; font-weight: bold; }
        
        /* å¸ƒå±€ */
        .bottom-layout { display: flex; flex-direction: column; gap: 30px; margin-top: 30px; }
        @media (min-width: 900px) {
            .bottom-layout { flex-direction: row; align-items: flex-start; justify-content: space-between; }
            .grid-area { flex: 0 0 auto; }
            .solution-area { flex: 1; min-width: 300px; max-width: 350px; position: sticky; top: 20px; }
        }
        
        .grid-wrapper { margin: 10px 0 0 0; overflow-x: auto; display: flex; justify-content: flex-start; padding-bottom: 10px; }
        .grid-table { border-collapse: collapse; background: #fff; border: 3px solid var(--ink-color); }
        .grid-table td, .grid-table th { border: 1px solid var(--grid-line); width: 42px; height: 42px; text-align: center; padding: 0; }
        .grid-table th { background: #eee; font-size: 1.4rem; vertical-align: middle; }
        .th-icon { filter: grayscale(100%); }
        .border-right-thick { border-right: 3px solid var(--ink-color) !important; }
        .border-bottom-thick { border-bottom: 3px solid var(--ink-color) !important; }
        .empty-zone { background: var(--bg-paper); border: none !important; }
        .cell { 
            cursor: pointer; 
            /* --- ä¿®æ”¹ç‚¹ï¼šåº”ç”¨æ‰‹å†™å­—ä½“ï¼Œå¹¶åŠ å¤§å­—å· --- */
            font-family: 'Patrick Hand', cursive; 
            font-size: 1.8rem; /* å­—å·åŠ å¤§ï¼Œå› ä¸ºæ‰‹å†™ä½“é€šå¸¸åå° */
            /* ------------------------------------- */
            padding-top: 5px; /* å¾®è°ƒå‚ç›´ä½ç½® */
        }
        .cell.cross { color: var(--accent-red); background: rgba(192, 57, 43, 0.05); }
        .cell.check { color: var(--accent-green); background: rgba(39, 174, 96, 0.05); }
        .cell.cross::after { content: 'âœ–'; }
        .cell.check::after { content: 'âœ”'; }
        
        .solution-box { border: 2px solid var(--ink-color); border-radius: 12px; padding: 20px; background: #fff; }
        .sol-row { display: flex; align-items: center; border-bottom: 1px solid #ccc; padding: 10px 0; margin-bottom: 10px; }
        .sol-label { font-weight: bold; margin-right: 10px; min-width: 90px; }
        select { flex: 1; border: none; font-size: 1rem; background: transparent; color: var(--ink-color); outline: none;}
        .btn-submit { width: 100%; background: var(--ink-color); color: #fff; padding: 15px; border: none; border-radius: 6px; font-size: 1.1rem; font-weight: bold; margin-top: 10px; cursor: pointer; }
        
        #modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 200; }
        #modal-box { display: none; position: fixed; top:50%; left:50%; transform: translate(-50%, -50%); background: #fff; padding: 25px; width: 85%; max-width: 350px; border-radius: 8px; text-align: center; border: 3px solid var(--ink-color); z-index: 201; }
        #modal-btn { background: var(--ink-color); color: #fff; border: none; padding: 8px 30px; margin-top: 15px; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 1rem;}
    
        /* --- åå­—å…‰æ ‡é«˜äº®æ ·å¼ --- */
        .highlight-guide {
            /* ä½¿ç”¨æ·¡æ·¡çš„å¢¨æ°´è‰²ä½œä¸ºé«˜äº®ï¼Œé€‚åº”çº¸å¼ é£æ ¼ */
            background-color: rgba(44, 62, 80, 0.1) !important;
            transition: background-color 0s; /* å“åº”è¦å¿«ï¼Œå»æ‰è¿‡æ¸¡ */
        }

        /* --- ä¼˜åŒ–ï¼šå¯åˆ’æ‰çš„çº¿ç´¢ --- */
        .clue-item { 
            cursor: pointer; 
            transition: all 0.2s;
            /* å¢åŠ ä¸€ç‚¹ç‚¹å‡»åŒºåŸŸï¼Œé˜²è¯¯è§¦ */
            padding: 4px 0 4px 20px; 
        }
        .clue-item:hover {
            color: var(--ink-color);
            background-color: rgba(0,0,0,0.03);
        }
        /* è¢«åˆ’æ‰çš„çŠ¶æ€ */
        .clue-item.done {
            text-decoration: line-through;
            color: #999;
            opacity: 0.6;
        }
        /* å¢åŠ æ‰‹å†™ä½“æ„Ÿè§‰çš„ç¬¦å· (å¯é€‰ï¼Œå¦‚æœä»¥åæƒ³åŠ å­—ä½“çš„è¯) */
        .cell { font-family: "Comic Sans MS", "Chalkboard SE", sans-serif; }

        /* --- æç¤ºå°å­—æ ·å¼ --- */
        .hint-text {
            font-size: 0.8rem;
            color: #999; /* æµ…ç°è‰²ï¼Œä¸æŠ¢çœ¼ */
            font-weight: normal; /* å–æ¶ˆåŠ ç²— */
            margin-left: 10px; /* ç¨å¾®æ‹‰å¼€ç‚¹è·ç¦» */
            font-family: sans-serif; /* ç”¨å›æ— è¡¬çº¿å­—ä½“ï¼Œæ¸…æ™°æ˜“è¯» */
        }
    </style>
</head>
<body>
<div class="container">
    <nav class="nav-bar">
        <button class="nav-btn" id="btn-prev" onclick="game.changeLevel(-1)">â—€ ä¸Šä¸€æ¡ˆ</button>
        <span class="case-title" id="level-display">CASE 1</span>
        <button class="nav-btn" id="btn-next" onclick="game.changeLevel(1)">ä¸‹ä¸€æ¡ˆ â–¶</button>
    </nav>
    <header>
        <div class="header-left">
            <h1 id="title-text">åŠ è½½ä¸­...</h1>
            <span id="diff-tag"></span>
        </div>
        
        <!-- æ™ºèƒ½è¾…åŠ©å¼€å…³ -->
        <div class="smart-mode-control">
            <span>æ™ºèƒ½æ¨¡å¼</span>
            <span class="tooltip-icon">?
                <span class="tooltip-text">åŠŸèƒ½æè¿°ï¼šå¢åŠ ä¸€ä¸ªâ€œè‡ªåŠ¨å¡«å……â€å¼€å…³ã€‚å½“ç©å®¶åœ¨ä¸€ä¸ªæ ¼å­é‡Œæ‰“å‹¾ï¼ˆâœ”ï¼‰æ—¶ï¼Œç¨‹åºè‡ªåŠ¨æŠŠè¯¥è¡Œã€è¯¥åˆ—çš„å…¶ä»–æ ¼å­æ‰“å‰ï¼ˆâœ–ï¼‰ã€‚</span>
            </span>
            <label class="switch">
                <input type="checkbox" id="smart-toggle" onchange="game.toggleSmartMode()">
                <span class="slider"></span>
            </label>
        </div>
    </header>
    <div class="intro-box" id="intro-text"></div>
    <div class="section-label">å«Œç–‘äººï¼š</div>
    <div class="cards-list" id="suspects-container"></div>
    <div class="section-label">åœ°ç‚¹ï¼š</div>
    <div class="grid-cards" id="locations-container"></div>
    <div class="section-label">å‡¶å™¨ï¼š</div>
    <div class="grid-cards" id="weapons-container"></div>
    <div class="section-label">
        çº¿ç´¢ä¸è¯æ®ï¼š<span class="hint-text">(ç‚¹å‡»æ–‡å­—å¯åˆ’æ‰)</span>
    </div>
    <div class="clues-box" id="clues-container"></div>
    <div class="bottom-layout">
        <div class="grid-area">
            <div class="notes-header">
                <span class="notes-title">ä¾¦æ¢ç¬”è®°ï¼š</span>
                <button class="btn-reset-board" onclick="game.reset()">ğŸ”„ é‡ç½®æ£‹ç›˜</button>
            </div>
            <div class="grid-wrapper" id="grid-main"></div>
        </div>
        <div class="solution-area">
            <div class="section-label" style="margin-top:0;">ç»“æ¡ˆé™ˆè¯ï¼š</div>
            <div class="solution-box">
                <div class="sol-row"><span class="sol-label">å‡¶æ‰‹æ˜¯è°ï¼Ÿ</span><select id="ans-suspect"></select></div>
                <div class="sol-row"><span class="sol-label">å‡¶å™¨æ˜¯ä»€ä¹ˆï¼Ÿ</span><select id="ans-weapon"></select></div>
                <div class="sol-row"><span class="sol-label">åœ¨å“ªå„¿ï¼Ÿ</span><select id="ans-location"></select></div>
                <button class="btn-submit" onclick="game.submit()">ç»“æ¡ˆæäº¤</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-overlay"></div>
<div id="modal-box">
    <h3 id="modal-title" style="margin-top:0;"></h3>
    <p id="modal-msg"></p>
    <button id="modal-btn" onclick="game.onModalClose()">å…³é—­</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<!-- å¼•å…¥æ•°æ®æ–‡ä»¶ -->
<script src="data.js"></script>

<script>
const game = {
    currentLevelIdx: 0,
    allStates: {},
    solvedStatus: [],
    pendingNextLevel: false,
    isSmartMode: false, // æ™ºèƒ½æ¨¡å¼çŠ¶æ€

    init() {
        if (typeof GAME_DATA === 'undefined') {
            alert('é”™è¯¯ï¼šæ— æ³•åŠ è½½ data.jsï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„ã€‚');
            return;
        }
        
        // 1. å°è¯•ä» LocalStorage è¯»å–æ•°æ®
        this.loadData();

        // 2. åˆå§‹åŒ–UIçŠ¶æ€
        document.getElementById('smart-toggle').checked = this.isSmartMode;

        this.loadLevel(this.currentLevelIdx);
    },

    // æ ¸å¿ƒï¼šä¿å­˜æ•°æ®åˆ°æœ¬åœ°
    saveData() {
        const saveData = {
            currentLevelIdx: this.currentLevelIdx,
            allStates: this.allStates,
            solvedStatus: this.solvedStatus,
            isSmartMode: this.isSmartMode
        };
        localStorage.setItem('murdle_save_v1', JSON.stringify(saveData));
    },

    // æ ¸å¿ƒï¼šä»æœ¬åœ°è¯»å–æ•°æ®
    loadData() {
        const raw = localStorage.getItem('murdle_save_v1');
        if (raw) {
            try {
                const data = JSON.parse(raw);
                // æ¢å¤æ•°æ®
                this.currentLevelIdx = data.currentLevelIdx || 0;
                this.allStates = data.allStates || {};
                this.solvedStatus = data.solvedStatus || new Array(GAME_DATA.length).fill(false);
                this.isSmartMode = data.isSmartMode || false;
            } catch (e) {
                console.error("è¯»å–å­˜æ¡£å¤±è´¥", e);
                // å¤±è´¥åˆ™åˆå§‹åŒ–é»˜è®¤
                this.solvedStatus = new Array(GAME_DATA.length).fill(false);
            }
        } else {
            this.solvedStatus = new Array(GAME_DATA.length).fill(false);
        }
    },

    toggleSmartMode() {
        this.isSmartMode = document.getElementById('smart-toggle').checked;
        this.saveData(); // è®°ä½ç”¨æˆ·çš„é€‰æ‹©
    },

    loadLevel(idx) {
        if (idx < 0 || idx >= GAME_DATA.length) return;
        
        // æ¯æ¬¡åˆ‡å…³ä¿å­˜ä¸€ä¸‹å½“å‰è¿›åº¦
        this.saveData();

        window.scrollTo({ top: 0, behavior: 'smooth' });

        this.currentLevelIdx = idx;
        const data = GAME_DATA[idx];
        
        document.getElementById('title-text').innerText = `${idx + 1}. ${data.title}`;
        document.getElementById('diff-tag').innerText = data.difficulty;
        document.getElementById('intro-text').innerText = data.intro;
        document.getElementById('level-display').innerText = `CASE ${idx + 1}`;
        
        this.renderCards('suspects-container', data.suspects, 'sus');
        this.renderCards('locations-container', data.locations, 'item');
        this.renderCards('weapons-container', data.weapons, 'item');
        // æ¸²æŸ“çº¿ç´¢ï¼ˆå¢åŠ äº†ç‚¹å‡»åˆ’æ‰åŠŸèƒ½ï¼‰
        document.getElementById('clues-container').innerHTML = data.clues.map(c => 
            `<div class="clue-item" onclick="this.classList.toggle('done')">${c}</div>`
        ).join('');
        
        this.renderGrid(data);
        this.fillSelects(data);
        
        const btnNext = document.getElementById('btn-next');
        const btnPrev = document.getElementById('btn-prev');
        btnPrev.disabled = (idx === 0);

        const isLastLevel = (idx === GAME_DATA.length - 1);
        const isCurrentSolved = this.solvedStatus[idx];

        if (isLastLevel) {
            btnNext.disabled = true;
            btnNext.innerText = "å·²å®Œç»“";
            btnNext.style.opacity = "0.6";
        } else if (!isCurrentSolved) {
            btnNext.disabled = true;
            btnNext.innerText = "ğŸ”’ å¾…è§£é”";
            btnNext.title = "è¯·å…ˆæˆåŠŸä¾¦ç ´å½“å‰æ¡ˆä»¶";
        } else {
            btnNext.disabled = false;
            btnNext.innerText = "ä¸‹ä¸€æ¡ˆ â–¶";
            btnNext.title = "";
        }

        if (!this.allStates[idx]) this.allStates[idx] = {};
        this.updateView();
    },

    changeLevel(offset) { this.loadLevel(this.currentLevelIdx + offset); },

    renderCards(containerId, list, type) {
        const el = document.getElementById(containerId);
        if (type === 'sus') {
            el.innerHTML = list.map(s => `
                <div class="suspect-card">
                    <div class="sus-icon-box"><div class="sus-icon">${s.icon}</div><div class="sus-name-short">${s.name}</div></div>
                    <div class="sus-info"><div class="sus-desc">${s.desc}</div><div class="sus-traits">${s.traits}</div></div>
                </div>`).join('');
        } else {
            el.innerHTML = list.map(item => `
                <div class="item-card">
                    <div class="item-icon">${item.icon}</div><div class="item-name">${item.name}</div>
                    <div class="item-tag">${item.tag}</div><div class="item-desc">${item.desc}</div>
                </div>`).join('');
        }
    },
    
    renderGrid(data) {
        const div = document.getElementById('grid-main');
        let html = `<table class="grid-table"><thead><tr><th style="background:#fff; border:none;"></th>`;
        data.suspects.forEach((s, i) => { const cls = (i === data.suspects.length - 1) ? 'border-right-thick' : ''; html += `<th class="th-icon ${cls}">${s.icon}</th>`; });
        data.locations.forEach(l => { html += `<th class="th-icon">${l.icon}</th>`; });
        html += `</tr></thead><tbody>`;
        
        data.weapons.forEach((w, wIdx) => {
            const rowCls = (wIdx === data.weapons.length - 1) ? 'border-bottom-thick' : '';
            html += `<tr class="${rowCls}"><th class="th-icon" style="background:#eee; border-right:1px solid #999;">${w.icon}</th>`;
            data.suspects.forEach((s, sIdx) => { const bCls = (sIdx === data.suspects.length - 1) ? 'border-right-thick' : ''; const key = `${s.id}-${w.id}`; html += `<td class="cell ${bCls}" id="c-${key}" onclick="game.toggle('${key}')"></td>`; });
            data.locations.forEach(l => { const key = `${w.id}-${l.id}`; html += `<td class="cell" id="c-${key}" onclick="game.toggle('${key}')"></td>`; });
            html += `</tr>`;
        });
        
        data.locations.forEach((lRow, lIdx) => {
            html += `<tr><th class="th-icon" style="background:#eee; border-right:1px solid #999;">${lRow.icon}</th>`;
            data.suspects.forEach((s, sIdx) => { const bCls = (sIdx === data.suspects.length - 1) ? 'border-right-thick' : ''; const key = `${s.id}-${lRow.id}`; html += `<td class="cell ${bCls}" id="c-${key}" onclick="game.toggle('${key}')"></td>`; });
            html += `<td class="empty-zone" colspan="${data.locations.length}"></td></tr>`;
        });
        html += `</tbody></table>`;
        div.innerHTML = html;
        
        // æ·»åŠ åå­—å…‰æ ‡é«˜äº®ç›‘å¬
        const table = div.querySelector('.grid-table');
        
        // é¼ æ ‡ç§»å…¥ç›‘å¬
        table.addEventListener('mouseover', (e) => {
            // åªæœ‰ç¢°åˆ°äº¤äº’æ ¼å­æ‰è§¦å‘
            const cell = e.target.closest('td.cell');
            if (!cell) return;

            const row = cell.parentElement;
            const colIndex = cell.cellIndex; // è·å–å½“å‰åˆ—ç´¢å¼•

            // 1. é«˜äº®æ•´è¡Œ (ç»™å½“å‰è¡Œçš„æ‰€æœ‰å­å…ƒç´ åŠ ç±»)
            Array.from(row.children).forEach(child => child.classList.add('highlight-guide'));

            // 2. é«˜äº®æ•´åˆ— (éå†æ‰€æœ‰è¡Œï¼Œæ‰¾åˆ°å¯¹åº”åˆ—ç´¢å¼•çš„å…ƒç´ åŠ ç±»)
            Array.from(table.rows).forEach(tr => {
                const target = tr.children[colIndex];
                if (target) target.classList.add('highlight-guide');
            });
        });

        // é¼ æ ‡ç§»å‡ºç›‘å¬
        table.addEventListener('mouseout', () => {
            // ç§»é™¤æ‰€æœ‰é«˜äº®ç±»
            const highlighted = table.querySelectorAll('.highlight-guide');
            highlighted.forEach(el => el.classList.remove('highlight-guide'));
        });

    },
    
    // --- ä¿®æ”¹åçš„ç‚¹å‡»é€»è¾‘ï¼šä¼˜å…ˆæ‰“å‹¾ ---
    toggle(key) {
        const state = this.allStates[this.currentLevelIdx];
        const val = state[key] || 0;
        
        // é€»è¾‘å˜æ›´ï¼š0(ç©º) -> 2(âœ”) -> 1(âœ–) -> 0(ç©º)
        let nextVal;
        if (val === 0) {
            nextVal = 2; // ç¬¬ä¸€ä¸‹ç›´æ¥å˜ å‹¾
        } else if (val === 2) {
            nextVal = 1; // ç¬¬äºŒä¸‹å˜ å‰
        } else {
            nextVal = 0; // ç¬¬ä¸‰ä¸‹å˜ ç©º
        }
        
        state[key] = nextVal;

        // --- æ™ºèƒ½è¾…åŠ©é€»è¾‘ ---
        // è¿™é‡Œçš„é€»è¾‘ä¸ç”¨å˜ï¼šåªè¦å˜æˆäº†å‹¾(2)ï¼Œå°±è§¦å‘è‡ªåŠ¨æ’ä»–
        if (this.isSmartMode && nextVal === 2) { 
            this.applySmartLogic(key);
        }

        this.updateView();
        this.saveData(); 
    },

    // æ™ºèƒ½å¡«å……ç®—æ³•ï¼šæ‰¾å‡ºåŒè¡ŒåŒåˆ—å¹¶æ‰“å‰
    applySmartLogic(key) {
        const parts = key.split('-');
        const id1 = parts[0];
        const id2 = parts[1];
        const data = GAME_DATA[this.currentLevelIdx];
        const state = this.allStates[this.currentLevelIdx];

        // è¾…åŠ©å‡½æ•°ï¼šç»™æŒ‡å®škeyæ‰“å‰ï¼ˆå¦‚æœå®ƒä¸æ˜¯å‹¾çš„è¯ï¼‰
        const crossOut = (k) => {
            if (state[k] !== 2) state[k] = 1; 
        };

        // æˆ‘ä»¬éœ€è¦åˆ¤æ–­ id1 å’Œ id2 å±äºå“ªä¸€ç±» (Suspect, Weapon, Location)
        // ç®€å•çš„åˆ¤æ–­æ–¹æ³•ï¼šéå†æ•°æ®æºçš„ID
        const isIdIn = (id, list) => list.some(item => item.id === id);

        let type = ''; // 'SW', 'WL', 'SL'
        
        if (isIdIn(id1, data.suspects)) {
            if (isIdIn(id2, data.weapons)) type = 'SW'; // å«Œç–‘äºº-å‡¶å™¨
            else if (isIdIn(id2, data.locations)) type = 'SL'; // å«Œç–‘äºº-åœ°ç‚¹
        } else if (isIdIn(id1, data.weapons)) {
            if (isIdIn(id2, data.locations)) type = 'WL'; // å‡¶å™¨-åœ°ç‚¹
        }

        // æ ¹æ®ç±»å‹æ‰§è¡Œè¡Œåˆ—æ’é™¤
        if (type === 'SW') {
            // åŒè¡Œ(S)å…¶ä»–Wæ‰“å‰
            data.weapons.forEach(w => { if(w.id !== id2) crossOut(`${id1}-${w.id}`); });
            // åŒåˆ—(W)å…¶ä»–Sæ‰“å‰
            data.suspects.forEach(s => { if(s.id !== id1) crossOut(`${s.id}-${id2}`); });
        } else if (type === 'SL') {
            // åŒè¡Œ(S)å…¶ä»–Læ‰“å‰
            data.locations.forEach(l => { if(l.id !== id2) crossOut(`${id1}-${l.id}`); });
            // åŒåˆ—(L)å…¶ä»–Sæ‰“å‰
            data.suspects.forEach(s => { if(s.id !== id1) crossOut(`${s.id}-${id2}`); });
        } else if (type === 'WL') {
            // åŒè¡Œ(W)å…¶ä»–Læ‰“å‰
            data.locations.forEach(l => { if(l.id !== id2) crossOut(`${id1}-${l.id}`); });
            // åŒåˆ—(L)å…¶ä»–Wæ‰“å‰
            data.weapons.forEach(w => { if(w.id !== id1) crossOut(`${w.id}-${id2}`); });
        }
    },

    updateView() {
        const state = this.allStates[this.currentLevelIdx];
        document.querySelectorAll('.cell').forEach(el => {
            const key = el.id.replace('c-', '');
            const val = state[key] || 0;
            el.className = el.className.replace(/ cross| check/g, '');
            if (val === 1) el.classList.add('cross');
            if (val === 2) el.classList.add('check');
        });
    },
    fillSelects(data) {
        const fill = (id, list) => {
            const sel = document.getElementById(id);
            sel.innerHTML = '<option value="">...</option>';
            list.forEach(i => { const opt = document.createElement('option'); opt.value = i.id; opt.innerText = i.name; sel.appendChild(opt); });
        };
        fill('ans-suspect', data.suspects); fill('ans-weapon', data.weapons); fill('ans-location', data.locations);
    },
    
    // --- æ”¯æŒåŠ å¯†ç­”æ¡ˆçš„æäº¤é€»è¾‘ ---
    submit() {
        const data = GAME_DATA[this.currentLevelIdx];
        const state = this.allStates[this.currentLevelIdx] || {};

        const s = document.getElementById('ans-suspect').value;
        const w = document.getElementById('ans-weapon').value;
        const l = document.getElementById('ans-location').value;

        if(!s || !w || !l) return showModal('æç¤º', 'è¯·å¡«å®Œæ‰€æœ‰é€‰é¡¹', false);

        // 1. ä¸€è‡´æ€§æ£€æŸ¥ (ä¿æŒä¸å˜)
        const key1 = `${s}-${w}`;
        const key2 = `${w}-${l}`;
        const key3 = `${s}-${l}`;
        const isChecked = (k) => (state[k] === 2);

        if (!isChecked(key1) || !isChecked(key2) || !isChecked(key3)) {
            return showModal('ğŸ“ è¯æ®ä¸è¶³', 'ä½ çš„â€œä¾¦æ¢ç¬”è®°â€è¿˜æ’‘ä¸èµ·è¿™ä»½â€œç»“æ¡ˆé™ˆè¯â€ã€‚\n\nä¼˜ç§€çš„æ¨è®ºéœ€è¦ç¡®å‡¿çš„è¯æ®æ”¯æ’‘ã€‚è¯·å›åˆ°ç¬”è®°è¡¨æ ¼ï¼Œå°†ä½ é€‰å®šçš„çº¿ç´¢ä¸€ä¸€å‹¾é€‰å¯¹é½ã€‚\n\næˆ‘ä»¬éœ€è¦çš„æ˜¯æ— æ‡ˆå¯å‡»çš„è¯æ®é“¾ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸€ä¸ªç›´è§‰ã€‚', false);
        }

        // 2. çœŸç›¸æ£€æŸ¥ (æ”¯æŒ åŠ å¯†å­—ç¬¦ä¸² å’Œ æ˜æ–‡å¯¹è±¡ ä¸¤ç§æ ¼å¼)
        let isAnswerCorrect = false;

        // ç”Ÿæˆç©å®¶ç­”æ¡ˆçš„æŒ‡çº¹ï¼šæ ¼å¼ä¸º "å‡¶æ‰‹ID-å‡¶å™¨ID-åœ°ç‚¹ID" çš„ Base64 ç¼–ç 
        // ä¾‹å¦‚ï¼šA-CANDLE-BATH  =>  QS1DQU5ETEUtQkFUSA==
        const playerHash = btoa(`${s}-${w}-${l}`);

        if (typeof data.solution === 'string') {
            // æƒ…å†µAï¼šå¦‚æœ data.js é‡Œå­˜çš„æ˜¯åŠ å¯†å­—ç¬¦ä¸²ï¼Œç›´æ¥æ¯”å¯¹å­—ç¬¦ä¸²
            isAnswerCorrect = (data.solution === playerHash);
        } else {
            // æƒ…å†µBï¼šå¦‚æœ data.js é‡Œå­˜çš„æ˜¯æ—§ç‰ˆå¯¹è±¡ï¼ŒæŒ‰æ—§é€»è¾‘æ¯”å¯¹ (æ–¹ä¾¿ä½ è‡ªå·±æµ‹è¯•)
            isAnswerCorrect = (s === data.solution.s && w === data.solution.w && l === data.solution.l);
        }

        if (isAnswerCorrect) {
            this.solvedStatus[this.currentLevelIdx] = true;
            this.saveData();
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#c0392b', '#27ae60', '#f1c40f', '#2980b9'] });

            const hasNext = (this.currentLevelIdx < GAME_DATA.length - 1);
            this.pendingNextLevel = hasNext; 

            if (hasNext) {
                showModal('ğŸ‰ ç ´æ¡ˆæˆåŠŸ', 'é€»è¾‘å®Œç¾ï¼ç‚¹å‡»æŒ‰é’®è¿›å…¥ä¸‹ä¸€æ¡ˆã€‚', true, 'ä¸‹ä¸€æ¡ˆ â–¶');
            } else {
                showModal('ğŸ† é€šå…³', 'æ­å–œï¼ä½ å·²ä¾¦ç ´æ‰€æœ‰æ¡ˆä»¶ï¼', false, 'å¤ªæ£’äº†');
            }
        } else {
            this.pendingNextLevel = false;
            showModal('â›” æ¨ç†é”™è¯¯', 'ä½ çš„ä¾¦æ¢ç¬”è®°è™½ç„¶ç”»å…¨äº†ï¼Œä½†æ¨å¯¼å‡ºçš„ç»“è®ºæ˜¯é”™è¯¯çš„ã€‚\nè¯·é‡æ–°æ£€æŸ¥çº¿ç´¢ï¼ŒçœŸæ­£çš„å‡¶æ‰‹ä¸æ˜¯è¿™ä¸€ä½...', false);
        }
    },

        reset() { 
        if(confirm('è¦æ“¦æ‰æœ¬æ¡ˆçš„æ‰€æœ‰ç¬”è®°é‡æ–°å¼€å§‹å—ï¼Ÿ')) { 
            this.allStates[this.currentLevelIdx] = {}; 
            this.updateView(); 
            this.saveData(); 
        } 
    },
    
// å¼¹çª—å…³é—­æ—¶çš„å›è°ƒ
    onModalClose() {
        document.getElementById('modal-overlay').style.display = 'none'; 
        document.getElementById('modal-box').style.display = 'none';
        
        // åªæœ‰å½“æ ‡è®°ä¸ºâ€œå‡†å¤‡è·³è½¬â€æ—¶ï¼ˆå³ç­”å¯¹äº†ï¼‰ï¼Œæ‰åˆ‡æ¢å…³å¡å¹¶æ»šå›é¡¶éƒ¨
        if (this.pendingNextLevel) {
            this.pendingNextLevel = false;
            this.changeLevel(1);
        }
        // å¦‚æœæ˜¯ç­”é”™å…³é—­å¼¹çª—ï¼Œä»£ç è¿è¡Œåˆ°è¿™é‡Œå°±ç»“æŸäº†
        // ä¸ä¼šé‡æ–°åŠ è½½é¡µé¢ï¼Œä¹Ÿä¸ä¼šæ»šåŠ¨ï¼Œæ–¹ä¾¿ä½ ç»§ç»­ä¿®æ”¹ç­”æ¡ˆ
    }
};

function showModal(title, msg, isSuccess, btnText = 'å…³é—­') { 
    document.getElementById('modal-title').innerText = title; 
    document.getElementById('modal-msg').innerText = msg; 
    document.getElementById('modal-btn').innerText = btnText;
    document.getElementById('modal-overlay').style.display = 'block'; 
    document.getElementById('modal-box').style.display = 'block'; 
}

window.onload = () => game.init();
</script>
</body>

</html>
