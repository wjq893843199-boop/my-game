<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
    <title>å¦™æ¢å¯»å‡¶ - æ¢æ¡ˆé›†</title>
    <style>
        :root {
            /* --- 1. é…è‰²ç³»ç»Ÿ (Refined Slate) --- */
            --bg-app: #F0F2F5; 
            --bg-panel: #FFFCF9; 
            --bg-subtle: #E9ECEF;
            --bg-active: #E7F1FF;

            --text-primary: #2D3436;
            --text-secondary: #8E9AAF; 
            --text-disabled: #BDC3C7;
            
            --ink-cross: #A63737; 
            --ink-check: #217346; 
            --ink-pencil: #636E72;

            --accent-focus: #2962FF;
            --border-main: #D1D5DB;
            --highlight-row: rgba(41, 98, 255, 0.05);
            --shadow-card: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.12);
            
            --cell-size: 54px;

            /* --- 2. å­—ä½“ç³»ç»Ÿ --- */
            --font-sans: "Noto Sans CJK SC", "PingFang SC", "Microsoft YaHei", sans-serif;
            --font-serif: "Noto Serif CJK SC", "Songti SC", "SimSun", serif;
            --font-mono: "Roboto Mono", "Courier New", monospace;

            /* èº«ä»½å±‚ */
            --id-font-family: var(--font-sans);
            --id-font-size: 16px;
            --id-font-weight: 700;
            --id-line-height: 1.4;
            --id-letter-spacing: 0.05em; 

            /* é€»è¾‘å±‚ */
            --logic-font-family: var(--font-sans);
            --logic-font-size: 15px;
            --logic-font-weight: 400;
            --logic-line-height: 1.7;

            /* å™äº‹å±‚ */
            --narrative-font-family: var(--font-serif);
            --narrative-font-size: 13px;
            --narrative-font-weight: 400;
            --narrative-line-height: 1.6;

            /* å±æ€§å±‚ */
            --attr-font-size: 12px;
            --attr-font-weight: 700;
        }

        * { box-sizing: border-box; user-select: none; }
        
        body { 
            height: 100vh; margin: 0; overflow: hidden; 
            background-color: var(--bg-app);
            font-family: var(--font-sans); 
            color: var(--text-primary); 
        }

        .app-shell { display: flex; flex-direction: column; height: 100vh; width: 100%; }

        /* --- GM DEBUG SYSTEM STYLES --- */
        #gm-panel {
            display: none; position: fixed; top: 100px; left: 100px; width: 320px;
            background: rgba(0, 0, 0, 0.9); color: #0f0; font-family: 'Courier New', monospace;
            padding: 15px; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 99999; border: 1px solid #0f0;
        }
        #gm-panel h3 { 
            cursor: move; user-select: none;
            margin: 0 0 10px 0; font-size: 16px; border-bottom: 1px solid #0f0; padding-bottom: 5px; display: flex; justify-content: space-between;
        }
        #gm-panel .gm-section { margin-bottom: 12px; }
        #gm-panel label { display: block; font-size: 12px; color: #aaa; margin-bottom: 4px; }
        #gm-panel .gm-val { color: #fff; font-weight: bold; font-size: 14px; word-break: break-all; }
        #gm-panel button {
            background: #003300; color: #0f0; border: 1px solid #0f0;
            padding: 4px 8px; margin: 4px 4px 0 0; cursor: pointer; font-size: 12px; font-family: inherit;
        }
        #gm-panel button:hover { background: #0f0; color: #000; }
        #gm-close { cursor: pointer; color: #f00; font-weight: bold; }
        
        /* UI X-Ray Class */
        .debug-xray * {
            outline: 1px solid rgba(255, 0, 0, 0.3) !important;
            background-color: rgba(255, 0, 0, 0.02) !important;
        }

        /* --- 1. Header --- */
        header {
            height: 64px; flex-shrink: 0; 
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 24px; 
            background: var(--bg-panel); 
            border-bottom: 1px solid var(--border-main);
            z-index: 100;
        }
        
        .header-left { width: 140px; display: flex; align-items: center; }
        
        .header-center { 
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            position: relative; 
        }
        
        .title-group { display: flex; align-items: center; gap: 8px; }
        .game-title { 
            font-family: var(--font-mono); 
            font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin: 0; letter-spacing: -0.5px; 
        }
        .case-info { font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px; font-weight: 500; letter-spacing: 0.5px; }

        .header-right { width: 140px; display: flex; justify-content: flex-end; }
        
        .nav-btn { 
            background: transparent; color: var(--text-primary); border: 1px solid var(--border-main);
            padding: 6px 14px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.8rem; 
            transition: all 0.1s;
        }
        .nav-btn:hover:not(:disabled) { background: var(--bg-subtle); border-color: var(--text-secondary); }
        .nav-btn:disabled { opacity: 0.4; cursor: not-allowed; background: transparent; border-color: var(--border-main); }

        .how-to-play-icon {
            display: inline-flex; justify-content: center; align-items: center;
            width: 20px; height: 20px; 
            background: var(--text-secondary); color: #fff; border-radius: 50%;
            font-size: 14px; font-weight: bold; cursor: help;
            font-family: sans-serif;
            position: relative; 
        }
        .how-to-play-icon:hover { background: var(--accent-focus); }

        .tooltip-text {
            visibility: hidden; opacity: 0;
            width: 300px; 
            background: var(--text-primary); color: #fff; 
            padding: 16px; border-radius: 6px; 
            position: absolute; 
            top: 36px; left: 50%; transform: translateX(-50%); 
            z-index: 9999; 
            font-size: 0.85rem; line-height: 1.6; text-align: left; font-weight: normal; font-family: sans-serif;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            transition: opacity 0.2s; pointer-events: none;
        }
        .tooltip-text strong { color: #fff; font-weight: 700; }
        .how-to-play-icon:hover .tooltip-text { visibility: visible; opacity: 1; }


        /* --- 2. Toolbar --- */
        .toolbar-container {
            height: 52px; background: var(--bg-panel); 
            border-bottom: 1px solid var(--border-main); 
            display: flex; justify-content: center; align-items: center; gap: 16px; flex-shrink: 0;
        }
        
        .tool-group { display: flex; gap: 4px; padding: 0 12px; border-right: 1px solid var(--border-main); align-items: center; }
        .tool-group:last-child { border: none; }
        
        .tool-btn {
            width: 38px; height: 38px; 
            border: 1px solid transparent; background: transparent; 
            border-radius: 4px; cursor: pointer; 
            display: flex; justify-content: center; align-items: center; font-size: 1.2rem; 
            transition: all 0.1s; position: relative; color: var(--text-secondary);
        }
        .tool-btn:hover:not(:disabled) { background: var(--bg-subtle); color: var(--text-primary); }
        .tool-btn.active { 
            background: var(--bg-active); 
            border-color: var(--accent-focus); 
            color: var(--accent-focus); 
        }
        .tool-btn:disabled { opacity: 0.3; cursor: default; }

        .tool-tooltip {
            position: absolute; bottom: 115%; left: 50%; transform: translateX(-50%); 
            background: var(--text-primary); color: #fff; font-size: 0.75rem; padding: 5px 10px; border-radius: 4px; 
            opacity: 0; pointer-events: none; transition: opacity 0.2s; white-space: nowrap; z-index: 200; font-family: sans-serif;
        }
        .tool-btn:hover .tool-tooltip { opacity: 1; }


        /* --- 3. Layout --- */
        .main-container { display: flex; flex: 1; overflow: hidden; background: var(--bg-app); }

        /* Sidebar */
        .sidebar { 
            overflow-y: auto; background: transparent;
            display: flex; flex-direction: column; padding-top: 16px;
        }
        #dossier-panel { width: 300px; min-width: 240px; border-right: 1px solid var(--border-main); background: var(--bg-panel); }
        #clue-panel { width: 300px; min-width: 240px; border-left: 1px solid var(--border-main); background: var(--bg-panel); }

        .section-label { 
            font-family: var(--font-mono);
            font-size: 0.8rem; 
            font-weight: 700; 
            color: var(--text-secondary); 
            border-bottom: 1px solid var(--border-main); /* å˜ç»†ä¸€ç‚¹ */
            margin: 20px 16px 12px; /* é¡¶éƒ¨å¢åŠ é—´è· */
            padding-bottom: 6px;
            letter-spacing: 1px; 
            text-transform: uppercase;
        }
        /* ç¬¬ä¸€ä¸ªæ ‡é¢˜ä¸éœ€è¦é¡¶éƒ¨é—´è· */
        .section-label:first-child { margin-top: 0; }

        /* --- æ–°å¢ï¼šè®©å«Œç–‘äºº/å‡¶å™¨/åœ°ç‚¹åˆ—è¡¨æ”¯æŒ Grid åŒåˆ— --- */
        #q2-suspects, #q3-locations, #q3-weapons {
            display: grid;
            /* è°ƒæ•´ minmax å®½åº¦ï¼Œç¡®ä¿åœ¨çª„å±ä¸‹æ˜¯å•åˆ—ï¼Œå®½å±ä¸‹æ˜¯åŒåˆ— */
            /* 240px å·¦å³æ˜¯ä¸€ä¸ªæ¯”è¾ƒèˆ’æœçš„å¡ç‰‡å®½åº¦ */
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); 
            gap: 10px;
            padding: 0 16px 16px;
        }
        /* Center Column Split */
        #center-column {
            flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative;
        }

        /* --- Draggable Cards (è§†è§‰å±‚çº§ç»Ÿä¸€ç‰ˆ) --- */
        /* --- Draggable Cards (Refined Dossier Style) --- */
    .info-card {
           background: #fff;
           border: 1px solid var(--border-main);
            border-radius: 8px; /* æ›´åœ†æ¶¦çš„è§’ */
            padding: 10px;
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
           cursor: grab;
           position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
           transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }

        /* æ‚¬åœä¸æ¿€æ´»çŠ¶æ€ */
    .info-card:hover {
            border-color: var(--accent-focus);
            box-shadow: 0 4px 12px rgba(41, 98, 255, 0.12);
            transform: translateY(-2px);
        }
    .info-card:active { cursor: grabbing; transform: scale(0.98); }

    /* æ’é™¤çŠ¶æ€ */
    .info-card.eliminated {
            opacity: 0.6;
            background: var(--bg-subtle);
            border-color: transparent;
            box-shadow: none;
           filter: grayscale(1); /* å®Œå…¨å»è‰² */
        }
    .info-card.eliminated::after {
    /* å¢åŠ ä¸€ä¸ªåˆ é™¤çº¿æ•ˆæœ */
    content: "";
    position: absolute;
    top: 50%; left: 10px; right: 10px;
    height: 1px;
    background: var(--text-disabled);
    pointer-events: none;
}

/* å·¦ä¾§å›¾æ ‡å®¹å™¨ (Visual Anchor) */
.card-avatar {
    flex-shrink: 0;
    width: 48px;
    height: 48px;
    background: var(--bg-subtle);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    border: 1px solid rgba(0,0,0,0.05);
}

/* å³ä¾§å†…å®¹åŒº */
.card-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-width: 0; /* ä¿®å¤ Flex å­å…ƒç´ æ–‡æœ¬æº¢å‡ºé—®é¢˜ */
}

/* æ ‡é¢˜å±‚ */
.card-title {
    font-family: var(--id-font-family);
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1.2;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* é•¿æ ‡é¢˜è‡ªåŠ¨çœç•¥ */
}

/* å™äº‹å±‚ (æè¿°) - å·²ä¿®å¤å…¼å®¹æ€§è­¦å‘Š */
.card-desc {
    font-family: var(--font-sans); /* ç»Ÿä¸€ä½¿ç”¨æ— è¡¬çº¿å­—ä½“ */
    font-size: 0.85rem;
    color: #636E72;
    line-height: 1.5;
    margin-bottom: 8px;
    
    /* å¤šè¡Œçœç•¥çš„æ ¸å¿ƒä»£ç  */
    display: -webkit-box;
    -webkit-line-clamp: 2; /* å…¼å®¹ Chrome/Safari/Edge */
    line-clamp: 2;         /* æ ‡å‡†å±æ€§ (æ·»åŠ è¿™ä¸€è¡Œå³å¯æ¶ˆé™¤è­¦å‘Š) */
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* --- æ›¿æ¢åŸæœ‰çš„ .card-meta ç›¸å…³æ ·å¼ --- */
/* --- å¡ç‰‡åº•éƒ¨æ ‡ç­¾å±‚ (å®Œå…¨ç»Ÿä¸€ç‰ˆ) --- */

.card-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;       /* ç¨å¾®å¢åŠ ä¸€ç‚¹é—´è·ï¼Œæ›´é€æ°” */
    margin-top: auto;
    padding-top: 6px; /* ä¸ä¸Šæ–¹æè¿°æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
}

/* æ ¸å¿ƒï¼šæ— è®ºæ˜¯ä»€ä¹ˆç±»å‹çš„æ ‡ç­¾ï¼Œæ ·å¼å®Œå…¨ä¸€è‡´ */
.meta-tag {
    /* å­—ä½“ç»Ÿä¸€ */
    font-family: var(--font-sans);
    font-size: 0.75rem;     /* 12px */
    font-weight: 500;       /* ç»Ÿä¸€å­—é‡ï¼šä¸åŠ ç²—ï¼Œä¹Ÿä¸è¿‡ç»†ï¼Œä¿æŒæ¸…æ™°çš„ä¸­ç­‰å­—é‡ */
    
    /* é¢œè‰²ç»Ÿä¸€ (ä½¿ç”¨ä¸­æ€§ç°ï¼Œä¸åå‘ä»»ä½•ä¸€æ–¹) */
    color: #4B5563;         /* ç»Ÿä¸€çš„æ·±ç°è‰²æ–‡å­— */
    background: #F3F4F6;    /* ç»Ÿä¸€çš„æµ…ç°èƒŒæ™¯ */
    border: 1px solid #E5E7EB; /* ç»Ÿä¸€çš„å¾®å¼±è¾¹æ¡† */
    
    /* ç›’æ¨¡å‹ç»Ÿä¸€ */
    padding: 2px 8px;
    border-radius: 4px;
    line-height: 1.4;
    
    /* ç¡®ä¿æ²¡æœ‰ä»»ä½•æµè§ˆå™¨é»˜è®¤æ ·å¼çš„å¹²æ‰° */
    box-sizing: border-box;
}

/* ç‰¹å¾æ ‡ç­¾ (ä¿®æ”¹ï¼šæ”¹ä¸ºæ·±å²©ç°ï¼Œä¸å†ä½¿ç”¨çº¢è‰²) */
.tag-trait {
    background: #E2E8F0; /* æ¯”èƒŒæ™¯ç¨æ·±çš„å†·ç°è‰² */
    color: #475569;      /* æ·±å²©ç°ï¼Œæ¸…æ™°ä¸”ä¸“ä¸šï¼Œä¸åˆºçœ¼ */
}

/* ç±»å‹æ ‡ç­¾ (ä¿æŒåŸæœ‰çš„æµ…ç°è‰²ç³») */
.tag-type {
    background: var(--bg-subtle);
    color: var(--text-secondary);
}

        /* å›¾æ ‡ï¼šç»Ÿä¸€å¤§å°å’Œä½ç½® */
        .info-icon { 
            font-size: 2rem; 
            min-width: 42px; 
            text-align: center; 
            line-height: 1.2; 
            margin-top: 0;
        }
        
        .info-body { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            justify-content: flex-start; /* ä¹Ÿå°±æ˜¯ä»ä¸Šå¾€ä¸‹æ’ */
        }
        
        /* å±‚çº§ 1ï¼šæ ‡é¢˜ (è§†è§‰é”šç‚¹) */
        .info-name { 
            font-family: var(--id-font-family); 
            font-size: 0.95rem; 
            font-weight: 800; /* æœ€ç²— */
            letter-spacing: var(--id-letter-spacing); 
            color: var(--text-primary); 
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        /* å±‚çº§ 2ï¼šæè¿° (å™äº‹é£å‘³) */
        .info-desc { 
            font-family: var(--narrative-font-family); /* å®‹ä½“åŒºåˆ† */
            font-size: 0.85rem; /* å­—å·é€‚ä¸­ï¼Œä¸å†è¿‡å° */
            font-weight: 400;   /* å¸¸è§„å­—é‡ */
            color: #555;        /* åŠ æ·±é¢œè‰²ï¼Œé˜²æ­¢çœ‹ä¸æ¸… */
            line-height: 1.5;
            margin-bottom: 6px; /* ä¸ä¸‹æ–¹å±æ€§æ‹‰å¼€è·ç¦» */
        }

        /* å±‚çº§ 3ï¼šé€»è¾‘å±æ€§ (å«Œç–‘äººç‰¹å¾ - çº¢è‰²) */
        .info-traits { 
            font-family: var(--font-sans);
            font-size: 0.75rem; 
            font-weight: 600;   /* ä¸­ç­‰ç²—åº¦ï¼Œä¸è¦æŠ¢æ ‡é¢˜çš„æˆ */
            color: var(--ink-cross); /* çº¢è‰²å¢¨æ°´ */
            line-height: 1.4;
            background: rgba(179, 38, 30, 0.05); /* ææ·¡çº¢åº•ï¼Œå¢åŠ å—çŠ¶æ„Ÿ */
            padding: 2px 4px;
            border-radius: 4px;
            display: inline-block;
        }

        /* å±‚çº§ 3ï¼šé€»è¾‘å±æ€§ (ç‰©å“æ ‡ç­¾ - ç°è‰²) */
        .info-tag {
            font-family: var(--font-sans);
            font-size: 0.75rem;
            font-weight: 600;   /* ä¸ traits ä¿æŒä¸€è‡´ */
            color: var(--text-secondary);
            background: var(--bg-subtle);
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            width: fit-content;
            border: 1px solid var(--border-main);
            line-height: 1.4;
        }

        /* Matrix */
        .matrix-view { 
            flex: 1; overflow: auto; display: flex; justify-content: center; align-items: center; 
            background-color: var(--bg-app); position: relative; 
        }
        
        .grid-table { 
            border-collapse: separate; border-spacing: 0; table-layout: fixed; 
            border: 1px solid var(--text-primary); background: #fff; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .grid-table th, .grid-table td { 
            width: var(--cell-size); height: var(--cell-size); 
            text-align: center; border: 1px solid var(--border-main); padding: 0; 
            overflow: hidden; line-height: var(--cell-size); vertical-align: middle;
        }
        
        .grid-table thead th { position: sticky; top: 0; background: var(--bg-subtle); z-index: 20; border-bottom: 1px solid var(--text-primary); font-size: 1.4rem; }
        .grid-table tbody th { position: sticky; left: 0; background: var(--bg-subtle); z-index: 10; border-right: 1px solid var(--text-primary); font-size: 1.4rem; }
        
        .highlight-cross { background-color: var(--highlight-row) !important; }
        .active-header { background-color: var(--text-primary) !important; color: #fff !important; }
        .spacer-cell { background-color: var(--bg-app) !important; border:none !important; cursor: default; }

        /* Cell States */
        .cell { font-family: 'Patrick Hand', cursive; font-size: 2rem; cursor: pointer; transition: background 0.05s; }
        .cell:hover:not(.spacer-cell) { background: #fafafa; }
        .cell[data-state="1"]::after { content: "Ã—"; color: var(--ink-cross); }
        .cell[data-state="2"]::after { content: "âœ“"; color: var(--ink-check); }
        .cell[data-state="3"]::after { content: "?"; color: var(--ink-pencil); font-size: 1.5rem; display: block; line-height: inherit; }
        .cell[data-state="4"]::after { content: "x"; color: var(--ink-pencil); font-size: 1.2rem; display: block; line-height: inherit; }

    /* --- Truth Zone (Bottom Panel) --- */
        #truth-zone {
            height: 160px; /* åŠ é«˜ä»¥å®¹çº³å†…å®¹ */
            background: #fff; 
            border-top: 1px solid var(--border-main);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 10px 20px; 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08); /* æµ®èµ·æ„Ÿé˜´å½± */
            z-index: 50;
            position: relative;
        }

        .truth-label { 
            font-family: var(--font-sans); /* ä¿®å¤ï¼šæ”¹ç”¨æ¸…æ™°çš„æ— è¡¬çº¿ä½“ */
            font-size: 0.9rem; 
            font-weight: 700; 
            color: var(--text-primary); /* ä¿®å¤ï¼šåŠ æ·±é¢œè‰² */
            margin-bottom: 12px; 
            letter-spacing: 1px; 
            text-transform: uppercase; 
        }

        .slot-container { display: flex; gap: 15px; align-items: center; }
        
        .truth-slot {
            width: 160px; height: 64px; 
            border: 2px dashed #bdc3c7; /* æ·±è‰²è™šçº¿æ¡† */
            border-radius: 8px; 
            background: #f7f9fc; /* æµ…ç°å‡¹æ§½èƒŒæ™¯ */
            
            display: flex; align-items: center; justify-content: center; gap: 8px;
            
            /* å­—ä½“ä¿®å¤ */
            font-family: var(--font-sans);
            color: var(--text-disabled); 
            font-size: 0.9rem; 
            font-weight: 600;
            
            transition: all 0.2s; cursor: pointer; position: relative;
        }

        .truth-slot.drag-over { 
            border-color: var(--accent-focus); 
            background: var(--bg-active); 
            transform: scale(1.02); 
        }

        .truth-slot.filled { 
            border-style: solid; 
            border-color: var(--text-primary); 
            background: #fff; 
            color: var(--text-primary); 
            box-shadow: var(--shadow-card); 
        }
        
        .truth-slot-icon { font-size: 1.8rem; }
        
        .truth-slot-text { 
            font-family: var(--id-font-family); /* å¼ºåˆ¶ä½¿ç”¨èº«ä»½å­—ä½“ */
            font-weight: 700; 
            font-size: 0.95rem; 
            color: var(--text-primary);
        }
        
        .slot-clear-btn {
            position: absolute; top: -8px; right: -8px; width: 20px; height: 20px;
            background: var(--ink-cross); color: #fff; border-radius: 50%; font-size: 12px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            opacity: 0; transition: opacity 0.2s;
        }
        .truth-slot:hover .slot-clear-btn { opacity: 1; }

        .submit-btn {
            background: var(--text-primary); 
            color: #fff; 
            border: none; 
            padding: 0 24px; 
            height: 64px;
            border-radius: 8px; 
            
            /* å­—ä½“ä¿®å¤ */
            font-family: var(--font-sans);
            font-weight: 700; 
            font-size: 1rem; 
            
            cursor: pointer; margin-left: 20px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); 
            transition: all 0.1s; 
            display: flex; align-items: center; gap: 8px;
        }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 0 rgba(0,0,0,0.2); }
        .submit-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
        .submit-btn:disabled { 
            background: var(--bg-subtle); 
            color: var(--text-disabled); 
            cursor: not-allowed; 
            box-shadow: none; 
            transform: none; 
        }

        /* Clues (ç»Ÿä¸€å­—ä½“ç‰ˆ) */
.clue-item { 
    /* å¸ƒå±€ä¸å¤–è§‚ */
    padding: 10px 14px; 
    margin: 0 16px 8px; 
    border-radius: 4px; 
    cursor: pointer; 
    background: #fff; 
    border: 1px solid var(--border-main); 
    border-left: 4px solid var(--text-secondary);
    color: var(--text-primary); 
    
    /* --- æ ¸å¿ƒä¿®æ”¹ï¼šå­—ä½“ç»Ÿä¸€ --- */
    font-family: var(--font-sans); /* å¼ºåˆ¶ä½¿ç”¨ä¸å·¦ä¾§ä¸€è‡´çš„æ— è¡¬çº¿å­—ä½“ */
    font-size: 0.9rem;             /* å­—å· */
    font-weight: 400;              /* å­—é‡ */
    line-height: 1.6;              /* è¡Œé«˜ */
    
    /* ç»†èŠ‚ä¼˜åŒ– */
    font-feature-settings: "tnum"; /* ç­‰å®½æ•°å­—ï¼Œæ–¹ä¾¿çœ‹æ•°å­— */
    transition: all 0.2s;          /* å¢åŠ æ‚¬åœæ—¶çš„å¹³æ»‘è¿‡æ¸¡ */
}

/* æ‚¬åœçŠ¶æ€ */
.clue-item:hover { 
    border-color: var(--accent-focus); 
    background: var(--bg-active); 
    transform: translateX(2px); /* é¼ æ ‡æ”¾ä¸Šå»ç¨å¾®å‘å³åŠ¨ä¸€ä¸‹ï¼Œå¢åŠ äº¤äº’æ„Ÿ */
}

/* å·²å®Œæˆ/åˆ’æ‰çŠ¶æ€ */
.clue-item.done { 
    text-decoration: line-through; 
    color: var(--text-disabled); 
    background: transparent; 
    border-color: transparent; 
    box-shadow: none; 
    border-left-color: var(--text-disabled); 
    opacity: 0.8;
}

        .resizer { width: 8px; cursor: col-resize; flex-shrink: 0; z-index: 50; background: transparent; }
        .resizer:hover { background: rgba(0,0,0,0.05); }

        /* Modal */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; backdrop-filter: blur(4px); }
        .modal { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: var(--bg-panel); padding: 32px; border-radius: 8px; z-index: 1001; text-align: center; width: 420px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid var(--border-main);
        }
        .modal h2 { font-family: var(--font-mono); font-size: 1.5rem; margin-top: 0; color: var(--text-primary); }
        
        .modal-btn-group { display: flex; justify-content: center; gap: 16px; margin-top: 24px; }
        .btn-modal { border: 1px solid var(--border-main); padding: 10px 24px; font-weight: 600; cursor: pointer; font-size: 0.9rem; border-radius: 4px; transition: all 0.2s; }
        .btn-secondary { background: transparent; color: var(--text-secondary); }
        .btn-secondary:hover { background: var(--bg-subtle); color: var(--text-primary); }
        .btn-primary { background: var(--text-primary); color: #fff; border-color: var(--text-primary); }
        .btn-primary:hover { background: #000; }

        /* Shake Animation */
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
        .shake { animation: shake 0.3s ease-in-out; background: var(--ink-cross) !important; color: #fff !important; border-color: var(--ink-cross) !important; }

        #smart-indicator { width: 6px; height: 6px; background: var(--border-main); border-radius: 50%; position: absolute; top: 8px; right: 8px; }
        #smart-indicator.on { background: var(--accent-focus); box-shadow: 0 0 4px var(--accent-focus); }
    </style>
</head>
<body>

<div class="app-shell">
    <header>
        <div class="header-left">
            <button class="nav-btn" id="btn-prev" onclick="game.changeLevel(-1)">â—€ ä¸Šä¸€æ¡ˆ</button>
        </div>

        <div class="header-center">
            <div class="title-group">
                <h1 class="game-title">å¦™æ¢å¯»å‡¶ - æ¢æ¡ˆé›†</h1>
                <div class="how-to-play-icon">?
                    <div class="tooltip-text">
                        <strong>ç©æ³•è¯´æ˜ï¼š</strong><br>
                        1. <strong>æ’é™¤æ³•</strong>ï¼šåˆ©ç”¨çº¿ç´¢åœ¨ç½‘æ ¼ä¸­æ¨ç†ã€‚<br>
                        2. <strong>é’¢ç¬”(âœ’ï¸)</strong>ï¼šè®°å½•é“è¯ (<span style="color:var(--ink-cross)">Ã—</span>æ’é™¤, <span style="color:var(--ink-check)">âœ“</span>ç¡®è®¤)ã€‚<br>
                        3. <strong>æ‹¼å‡‘çœŸç›¸</strong>ï¼šå°†å·¦ä¾§å¡ç‰‡æ‹–å…¥åº•éƒ¨æ’æ§½ã€‚<br>
                        4. <strong>æäº¤</strong>ï¼šåªæœ‰æ¨ç†å‡ºå®Œæ•´çš„å«Œç–‘äººã€å‡¶å™¨å’Œåœ°ç‚¹ï¼Œæ‰èƒ½ç»“æ¡ˆã€‚
                    </div>
                </div>
            </div>
            <div class="case-info" id="case-display-info">CASE 01 - Loading...</div>
        </div>

        <div class="header-right">
            <button class="nav-btn" id="btn-next" onclick="game.changeLevel(1)">ä¸‹ä¸€æ¡ˆ â–¶</button>
        </div>
    </header>

    <div class="toolbar-container">
        <div class="tool-group">
            <div class="tool-btn active" id="tool-pen" onclick="game.setTool('pen')">
                âœ’ï¸<div class="tool-tooltip">é’¢ç¬” (ç¡®ä¿¡)</div>
            </div>
            <div class="tool-btn" id="tool-pencil" onclick="game.setTool('pencil')">
                âœï¸<div class="tool-tooltip">é“…ç¬” (è‰ç¨¿)</div>
            </div>
            <div class="tool-btn" id="tool-eraser" onclick="game.setTool('eraser')">
                ğŸ§¹<div class="tool-tooltip">æ©¡çš®æ“¦ (æ‹–æ‹½)</div>
            </div>
        </div>
        <div class="tool-group">
            <div class="tool-btn" onclick="game.undo()">
                â†©ï¸<div class="tool-tooltip">ä¸Šä¸€æ­¥</div>
            </div>
            <div class="tool-btn" onclick="game.redo()">
                â†ªï¸<div class="tool-tooltip">ä¸‹ä¸€æ­¥</div>
            </div>
        </div>
        <div class="tool-group">
            <div class="tool-btn" onclick="game.saveSnapshot()">
                ğŸ“¥<div class="tool-tooltip">æš‚å­˜ç¬”è®°</div>
            </div>
            <div class="tool-btn" id="btn-load-snap" onclick="game.loadSnapshot()" disabled>
                ğŸ“¤<div class="tool-tooltip">è¯»å–æš‚å­˜</div>
            </div>
        </div>
        <div class="tool-group">
            <div class="tool-btn" onclick="game.toggleSmartMode()">
                ğŸ§ <div id="smart-indicator"></div>
                <div class="tool-tooltip">æ™ºèƒ½è¾…åŠ©</div>
            </div>
        </div>
        <div class="tool-group" style="border:none;">
            <div class="tool-btn" style="color: var(--ink-cross);" onclick="game.resetLevel()">
                ğŸ—‘ï¸<div class="tool-tooltip">æ¸…ç©ºé‡æ¥</div>
            </div>
        </div>
    </div>

    <main class="main-container">
            <!-- LEFT: Cards -->
        <aside class="sidebar" id="dossier-panel">
            <div class="section-label">SUSPECTS</div>
            <div id="q2-suspects"></div>
            
            <!-- äº¤æ¢ï¼šå…ˆæŠŠå‡¶å™¨æ”¾ä¸Šæ¥ -->
            <div class="section-label">WEAPONS</div>
            <div id="q3-weapons"></div>
            
            <!-- äº¤æ¢ï¼šåœ°ç‚¹æ”¾æœ€å -->
            <div class="section-label">LOCATIONS</div>
            <div id="q3-locations"></div>
        </aside>

        <div class="resizer" id="resizer-left"></div>

        <!-- CENTER: Matrix + Truth Zone -->
        <div id="center-column">
            <section class="matrix-view" id="matrix-container">
                <div id="grid-target"></div>
            </section>
            
            <section id="truth-zone">
                <div class="truth-label">ğŸ•µï¸ ç»“æ¡ˆé™ˆè¯ï¼šå°†çœŸç›¸å¡ç‰‡æ‹–å…¥ä¸‹æ–¹</div>
                <div class="slot-container">
                    <div class="truth-slot" id="slot-suspect" data-type="suspect">
                        <span>ğŸ‘¤ æ‹–å…¥å‡¶æ‰‹</span>
                    </div>
                    <div style="font-weight:bold; color:var(--text-disabled)">+</div>
                    <div class="truth-slot" id="slot-weapon" data-type="weapon">
                        <span>ğŸ”ª æ‹–å…¥å‡¶å™¨</span>
                    </div>
                    <div style="font-weight:bold; color:var(--text-disabled)">@</div>
                    <div class="truth-slot" id="slot-location" data-type="location">
                        <span>ğŸ“ æ‹–å…¥åœ°ç‚¹</span>
                    </div>
                    
                    <button class="submit-btn" id="btn-submit" onclick="game.submitTruth()" disabled>
                        <span>ğŸ“ æäº¤ç»“æ¡ˆ</span>
                    </button>
                </div>
            </section>
        </div>

        <div class="resizer" id="resizer-right"></div>

        <!-- RIGHT: Clues -->
        <aside class="sidebar" id="clue-panel">
            <div class="section-label">CLUES</div>
            <div id="clue-list"></div>
        </aside>
    </main>
</div>

<!-- GM Panel -->
<div id="gm-panel">
    <h3>GM è°ƒè¯•æ§åˆ¶å° <span id="gm-close" style="cursor:pointer;" onclick="debugSystem.toggleUI()">X</span></h3>
    <div class="gm-section">
        <label>å½“å‰å…³å¡ç­”æ¡ˆ (Base64è§£ç ):</label>
        <div class="gm-val" id="gm-solution-text">???</div>
    </div>
    <div class="gm-section">
        <button onclick="debugSystem.toggleXRay()">UI éª¨æ¶æ˜¾å½¢</button>
        <button onclick="debugSystem.instantWin()">ä¸€é”®é€šå…³</button>
        <button onclick="debugSystem.unlockAll()">è§£é”å…¨å…³</button>
        <button onclick="debugSystem.nukeSave()">åˆ æ¡£é‡ç½®</button>
    </div>
    <div class="gm-section">
        <label>è·³è½¬è‡³å…³å¡ (0-N):</label>
        <input type="number" id="gm-level-input" style="width:50px; background:#000; color:#0f0; border:1px solid #0f0;">
        <button onclick="debugSystem.jumpLevel()">Go</button>
    </div>
</div>

<div class="overlay" id="overlay"></div>
<div class="modal" id="modal">
    <h2 id="modal-title"></h2>
    <p id="modal-msg" style="line-height: 1.6; color:var(--text-secondary);"></p>
    <div class="modal-btn-group" id="modal-btns"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="data.js"></script>

<script>
const STATE = { EMPTY: 0, PEN_X: 1, PEN_V: 2, PENCIL_Q: 3, PENCIL_X: 4 };

// GM Debug System
const debugSystem = {
    buffer: [],
    secret: 'wangjiaqi',
    
    init() {
        window.addEventListener('keyup', (e) => {
            this.buffer.push(e.key);
            if (this.buffer.length > this.secret.length) this.buffer.shift();
            if (this.buffer.join('') === this.secret) {
                this.toggleUI();
                this.buffer = [];
            }
        });
        
        // Drag logic for GM Panel
        this.initDrag();
    },
    
    initDrag() {
        const el = document.getElementById('gm-panel');
        const header = el.querySelector('h3');
        let isDown = false;
        let offset = [0, 0];

        header.addEventListener('mousedown', (e) => {
            isDown = true;
            offset = [
                el.offsetLeft - e.clientX,
                el.offsetTop - e.clientY
            ];
        }, true);

        document.addEventListener('mouseup', () => {
            isDown = false;
        }, true);

        document.addEventListener('mousemove', (e) => {
            if (isDown) {
                e.preventDefault();
                el.style.left = (e.clientX + offset[0]) + 'px';
                el.style.top  = (e.clientY + offset[1]) + 'px';
            }
        }, true);
    },

    toggleUI() {
        const el = document.getElementById('gm-panel');
        const isVisible = el.style.display === 'block';
        el.style.display = isVisible ? 'none' : 'block';
        if (!isVisible) this.render();
    },

    render() {
        const data = GAME_DATA[game.idx];
        if (data && data.solution) {
            try {
                const decoded = atob(data.solution);
                document.getElementById('gm-solution-text').innerText = decoded;
            } catch(e) {
                document.getElementById('gm-solution-text').innerText = "Error decoding";
            }
        }
    },

    toggleXRay() {
        document.body.classList.toggle('debug-xray');
    },

    unlockAll() {
        game.solvedLevels = new Array(GAME_DATA.length).fill(true);
        game.saveGlobal();
        game.loadLevel(game.idx);
        alert("All levels unlocked.");
    },

    nukeSave() {
        if(confirm("NUKE ALL DATA?")) {
            localStorage.clear();
            location.reload();
        }
    },
    
    jumpLevel() {
        const val = parseInt(document.getElementById('gm-level-input').value);
        if (!isNaN(val)) game.loadLevel(val);
    },

    instantWin() {
        const data = GAME_DATA[game.idx];
        if (!data.fullTruth) {
            alert("âš ï¸ é”™è¯¯ï¼šå½“å‰å…³å¡ data.js ä¸­ç¼ºå°‘ 'fullTruth' é…ç½®ã€‚");
            return;
        }

        // 1. Grid Auto Fill (Logic from Truth)
        game.gridState = {};
        const allKeys = [];
        data.suspects.forEach(s => data.weapons.forEach(w => allKeys.push(`${s.id}-${w.id}`)));
        data.weapons.forEach(w => data.locations.forEach(l => allKeys.push(`${w.id}-${l.id}`)));
        data.suspects.forEach(s => data.locations.forEach(l => allKeys.push(`${s.id}-${l.id}`)));

        const trueKeys = new Set();
        data.fullTruth.forEach(([s, w, l]) => {
            trueKeys.add(`${s}-${w}`);
            trueKeys.add(`${w}-${l}`);
            trueKeys.add(`${s}-${l}`);
            game.gridState[`${s}-${w}`] = STATE.PEN_V;
            game.gridState[`${w}-${l}`] = STATE.PEN_V;
            game.gridState[`${s}-${l}`] = STATE.PEN_V;
        });

        allKeys.forEach(key => {
            if (!trueKeys.has(key)) game.gridState[key] = STATE.PEN_X;
        });
        
        game.saveLevelState();
        game.updateView();

        // 2. Auto Fill Truth Slots & Submit
        const solParts = atob(data.solution).split('-');
        game.truthState = {
            suspect: solParts[0],
            weapon: solParts[1],
            location: solParts[2]
        };
        game.updateTruthUI();
        
        // 3. Trigger Win
        setTimeout(() => game.submitTruth(), 200);
    }
};

const game = {
    idx: 0,
    currentTool: 'pen', 
    smartMode: false,
    gridState: {},
    solvedLevels: [],
    clueState: [],
    eliminatedCards: [],
    historyStack: [],
    redoStack: [],
    snapshot: null,
    cellSize: 46,
    isDragging: false, 
    truthState: { suspect: null, weapon: null, location: null },

    init() {
        this.loadGlobalSave();
        this.loadLevel(this.idx);
        this.initResizers();
        this.initZoom();
        this.initDragDrop();
        this.updateToolbarUI();
        document.addEventListener('mouseup', () => { this.isDragging = false; });
        
        // Init GM
        debugSystem.init();
    },

    loadGlobalSave() {
        const raw = localStorage.getItem('murdle_final_v5_global');
        if (raw) {
            const d = JSON.parse(raw);
            this.idx = d.currentIdx || 0;
            this.solvedLevels = d.solvedLevels || [];
            this.smartMode = d.smartMode || false;
        } else {
            this.solvedLevels = new Array(GAME_DATA.length).fill(false);
        }
    },
    
    saveGlobal() {
        localStorage.setItem('murdle_final_v5_global', JSON.stringify({
            currentIdx: this.idx,
            solvedLevels: this.solvedLevels,
            smartMode: this.smartMode
        }));
    },

    loadLevelState() {
        const key = `murdle_final_v5_level_${this.idx}`;
        const raw = localStorage.getItem(key);
        if (raw) {
            const d = JSON.parse(raw);
            this.gridState = d.grid || {};
            this.clueState = d.clues || [];
            this.eliminatedCards = d.eliminated || [];
            this.truthState = d.truth || { suspect: null, weapon: null, location: null };
            this.snapshot = d.snapshot || null;
        } else {
            this.resetLevelData();
        }
        this.historyStack = [];
        this.redoStack = [];
    },

    saveLevelState() {
        const key = `murdle_final_v5_level_${this.idx}`;
        localStorage.setItem(key, JSON.stringify({
            grid: this.gridState,
            clues: this.clueState,
            eliminated: this.eliminatedCards,
            truth: this.truthState,
            snapshot: this.snapshot
        }));
    },

    resetLevelData() {
        this.gridState = {};
        this.clueState = [];
        this.eliminatedCards = [];
        this.truthState = { suspect: null, weapon: null, location: null };
        this.historyStack = [];
        this.redoStack = [];
    },

    resetLevel() {
        if(confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰çš„æ¨ç†è®°å½•å—ï¼Ÿ')) {
            this.resetLevelData();
            this.saveLevelState();
            this.updateView();
            this.renderClues(); 
            this.renderCards();
            this.updateTruthUI();
        }
    },

    loadLevel(i) {
        if (i < 0 || i >= GAME_DATA.length) return;
        this.idx = i;
        this.loadLevelState();
        this.saveGlobal();

        const data = GAME_DATA[i];
        document.getElementById('case-display-info').innerText = `CASE ${String(i+1).padStart(2, '0')}: ${data.title}`;
        document.getElementById('btn-prev').disabled = (i === 0);
        
        const isCompleted = this.solvedLevels[i];
        document.getElementById('btn-next').disabled = !isCompleted || (i >= GAME_DATA.length - 1);

        this.renderCards();
        this.renderClues();
        this.renderGrid(data);
        this.updateView();
        this.updateTruthUI();
        this.updateToolbarUI();
    },

    renderCards() {
        const data = GAME_DATA[this.idx];
        // Note: added 'type' param to genCard for DragDrop
        document.getElementById('q2-suspects').innerHTML = data.suspects.map(s => this.genCard(s, 'suspect')).join('');
        document.getElementById('q3-locations').innerHTML = data.locations.map(l => this.genCard(l, 'location')).join('');
        document.getElementById('q3-weapons').innerHTML = data.weapons.map(w => this.genCard(w, 'weapon')).join('');
    },

    genCard(obj, type) {
        const isEliminated = this.eliminatedCards.includes(obj.id);
        
        // æ„å»ºæ ‡ç­¾ HTML
        let metaHtml = '';
    
        // 1. å«Œç–‘äººç‰¹å¾
        if (obj.traits) {
        // åªä½¿ç”¨ .meta-tagï¼Œå»æ‰ tag-trait ç±»åï¼Œä»æ ¹æºä¸Šæ¶ˆé™¤å·®å¼‚
           metaHtml += `<span class="meta-tag">${obj.traits}</span>`;
        }
    
        // 2. ç‰©å“/åœ°ç‚¹åˆ†ç±»
        if (obj.tag) {
        // åŒæ ·åªä½¿ç”¨ .meta-tag
           metaHtml += `<span class="meta-tag">${obj.tag}</span>`;
        }

        return `
        <div class="info-card ${isEliminated ? 'eliminated' : ''}" id="card-${obj.id}" 
            draggable="true" 
            ondragstart="game.onDragStart(event, '${obj.id}', '${type}', '${obj.icon}', '${obj.name}')"
            onclick="game.toggleCard('${obj.id}')" 
            oncontextmenu="event.preventDefault(); game.toggleCard('${obj.id}')">
            
            <div class="card-avatar">
                ${obj.icon}
            </div>
            
            <div class="card-content">
                <div class="card-title">${obj.name}</div>
                <div class="card-desc">${obj.desc || ''}</div>
                <div class="card-meta">
                    ${metaHtml}
                </div>
            </div>
        </div>`;
    },

    // --- Drag & Drop Logic ---
    onDragStart(e, id, type, icon, name) {
        e.dataTransfer.setData('text/plain', JSON.stringify({ id, type, icon, name }));
        e.dataTransfer.effectAllowed = 'copy';
    },

    initDragDrop() {
        const slots = document.querySelectorAll('.truth-slot');
        slots.forEach(slot => {
            slot.addEventListener('dragover', e => {
                e.preventDefault();
                slot.classList.add('drag-over');
            });
            slot.addEventListener('dragleave', e => {
                slot.classList.remove('drag-over');
            });
            slot.addEventListener('drop', e => {
                e.preventDefault();
                slot.classList.remove('drag-over');
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                
                if (slot.dataset.type === data.type) {
                    this.truthState[data.type] = data.id;
                    this.updateTruthUI();
                    this.saveLevelState();
                }
            });
        });
    },

    updateTruthUI() {
        const data = GAME_DATA[this.idx];
        const types = ['suspect', 'weapon', 'location'];
        let filledCount = 0;

        types.forEach(type => {
            const id = this.truthState[type];
            const slot = document.getElementById(`slot-${type}`);
            
            if (id) {
                // Find object data
                let obj;
                if(type==='suspect') obj = data.suspects.find(x=>x.id===id);
                else if(type==='weapon') obj = data.weapons.find(x=>x.id===id);
                else obj = data.locations.find(x=>x.id===id);

                if(obj) {
                    slot.innerHTML = `
                        <div class="truth-slot-icon">${obj.icon}</div>
                        <div class="truth-slot-text">${obj.name}</div>
                        <div class="slot-clear-btn" onclick="event.stopPropagation(); game.clearSlot('${type}')">âœ•</div>
                    `;
                    slot.classList.add('filled');
                    filledCount++;
                }
            } else {
                // Empty state
                const labels = { suspect: 'ğŸ‘¤ æ‹–å…¥å‡¶æ‰‹', weapon: 'ğŸ”ª æ‹–å…¥å‡¶å™¨', location: 'ğŸ“ æ‹–å…¥åœ°ç‚¹' };
                slot.innerHTML = `<span>${labels[type]}</span>`;
                slot.classList.remove('filled');
            }
        });

        document.getElementById('btn-submit').disabled = (filledCount < 3);
    },

    clearSlot(type) {
        this.truthState[type] = null;
        this.updateTruthUI();
        this.saveLevelState();
    },

    submitTruth() {
        const data = GAME_DATA[this.idx];
        const attempt = `${this.truthState.suspect}-${this.truthState.weapon}-${this.truthState.location}`;
        
        if (btoa(attempt) === data.solution) {
            this.onWin();
        } else {
            // Error feedback
            const btn = document.getElementById('btn-submit');
            btn.classList.add('shake');
            btn.style.background = 'var(--ink-cross)';
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span style="color:#fff">âŒ æ¨ç†é”™è¯¯</span>';
            setTimeout(() => {
                btn.classList.remove('shake');
                btn.style.background = '';
                btn.innerHTML = originalText;
            }, 1500);
        }
    },

    renderClues() {
        const data = GAME_DATA[this.idx];
        document.getElementById('clue-list').innerHTML = data.clues.map((c, idx) => `
            <div class="clue-item ${this.clueState.includes(idx) ? 'done' : ''}" 
                 onclick="game.toggleClue(${idx})">${c}</div>
        `).join('');
    },

    renderGrid(data) {
        const target = document.getElementById('grid-target');
        let h = `<table class="grid-table" id="matrix-main"><thead><tr><th style="background:var(--bg-subtle); border:none;"></th>`;
        data.suspects.forEach(s => h += `<th>${s.icon}</th>`);
        data.locations.forEach(l => h += `<th>${l.icon}</th>`);
        h += `</tr></thead><tbody>`;
        
        data.weapons.forEach(w => {
            h += `<tr><th>${w.icon}</th>`;
            data.suspects.forEach(s => h += this.genCell(s.id, w.id));
            data.locations.forEach(l => h += this.genCell(w.id, l.id));
            h += `</tr>`;
        });
        data.locations.forEach(lRow => {
            h += `<tr><th>${lRow.icon}</th>`;
            data.suspects.forEach(s => h += this.genCell(s.id, lRow.id));
            h += `<td colspan="${data.locations.length}" class="spacer-cell"></td></tr>`;
        });
        h += `</tbody></table>`;
        target.innerHTML = h;
        this.attachGridEvents();
    },

    genCell(rId, cId) {
        const key = `${rId}-${cId}`; 
        return `<td class="cell" id="c-${key}" data-key="${key}"></td>`;
    },

    setTool(tool) {
        this.currentTool = tool;
        this.updateToolbarUI();
    },

    toggleSmartMode() {
        this.smartMode = !this.smartMode;
        this.saveGlobal();
        this.updateToolbarUI();
    },

    saveSnapshot() {
        this.snapshot = JSON.stringify(this.gridState);
        this.saveLevelState();
        this.updateToolbarUI();
        const btn = document.querySelector('.tool-btn[onclick="game.saveSnapshot()"]');
        btn.style.background = "var(--bg-active)"; 
        setTimeout(() => { btn.style.background = ""; }, 500);
    },

    loadSnapshot() {
        if (!this.snapshot) return;
        if (confirm("æ¢å¤ç¬”è®°åˆ°æš‚å­˜ç‚¹ï¼Ÿå½“å‰æœªä¿å­˜çš„æ¨ç†å°†ä¸¢å¤±ã€‚")) {
            this.pushHistory();
            this.gridState = JSON.parse(this.snapshot);
            this.updateView();
            this.saveLevelState();
        }
    },

    updateToolbarUI() {
        ['pen', 'pencil', 'eraser'].forEach(t => {
            const el = document.getElementById(`tool-${t}`);
            if(t === this.currentTool) el.classList.add('active');
            else el.classList.remove('active');
        });
        
        const smartInd = document.getElementById('smart-indicator');
        if(this.smartMode) smartInd.classList.add('on'); else smartInd.classList.remove('on');

        const loadBtn = document.getElementById('btn-load-snap');
        if (this.snapshot) {
            loadBtn.removeAttribute('disabled');
            loadBtn.style.opacity = '1';
        } else {
            loadBtn.setAttribute('disabled', 'true');
            loadBtn.style.opacity = '0.5';
        }
    },

    pushHistory() {
        const stateClone = JSON.stringify(this.gridState);
        if (this.historyStack.length > 0 && this.historyStack[this.historyStack.length - 1] === stateClone) return;
        this.historyStack.push(stateClone);
        if (this.historyStack.length > 50) this.historyStack.shift();
        this.redoStack = []; 
    },

    undo() {
        if (this.historyStack.length === 0) return;
        const current = JSON.stringify(this.gridState);
        this.redoStack.push(current);
        const prev = this.historyStack.pop();
        this.gridState = JSON.parse(prev);
        this.updateView();
        this.saveLevelState();
    },

    redo() {
        if (this.redoStack.length === 0) return;
        const current = JSON.stringify(this.gridState);
        this.historyStack.push(current);
        const next = this.redoStack.pop();
        this.gridState = JSON.parse(next);
        this.updateView();
        this.saveLevelState();
    },

    toggleCard(id) {
        const idx = this.eliminatedCards.indexOf(id);
        if (idx > -1) this.eliminatedCards.splice(idx, 1);
        else this.eliminatedCards.push(id);
        this.renderCards(); this.saveLevelState();
    },

    toggleClue(idx) {
        const i = this.clueState.indexOf(idx);
        if(i > -1) this.clueState.splice(i, 1);
        else this.clueState.push(idx);
        this.renderClues(); 
        this.saveLevelState();
    },

    interactCell(key, isDragAction = false) {
        const currentVal = this.gridState[key] || STATE.EMPTY;
        
        if (isDragAction) {
            if (this.currentTool === 'eraser' && currentVal !== STATE.EMPTY) {
                this.gridState[key] = STATE.EMPTY;
                this.updateView();
                this.saveLevelState();
            }
            return;
        }

        let nextVal = currentVal;
        if (this.currentTool === 'eraser') {
            nextVal = STATE.EMPTY;
        } else if (this.currentTool === 'pen') {
            if (currentVal === STATE.EMPTY || currentVal >= STATE.PENCIL_Q) nextVal = STATE.PEN_X;
            else if (currentVal === STATE.PEN_X) nextVal = STATE.PEN_V;
            else nextVal = STATE.EMPTY;
        } else if (this.currentTool === 'pencil') {
            if (currentVal === STATE.EMPTY || currentVal === STATE.PEN_X || currentVal === STATE.PEN_V) nextVal = STATE.PENCIL_Q;
            else if (currentVal === STATE.PENCIL_Q) nextVal = STATE.PENCIL_X;
            else nextVal = STATE.EMPTY;
        }

        if (nextVal !== currentVal) {
            this.pushHistory(); 
            this.gridState[key] = nextVal;
            if (this.smartMode && nextVal === STATE.PEN_V && this.currentTool === 'pen') {
                this.applySmartFill(key);
            }
            this.updateView();
            this.saveLevelState();
        }
    },

    applySmartFill(key) {
        const [id1, id2] = key.split('-');
        const data = GAME_DATA[this.idx];
        const cross = (k) => { 
            if (this.gridState[k] !== STATE.PEN_V) {
                this.gridState[k] = STATE.PEN_X; 
            }
        };
        const isSus = (i) => data.suspects.some(x => x.id === i);
        const isWea = (i) => data.weapons.some(x => x.id === i);
        const isLoc = (i) => data.locations.some(x => x.id === i);

        // Robust Smart Fill Logic
        if (isSus(id1) && isWea(id2)) {
            data.weapons.forEach(w => { if(w.id !== id2) cross(`${id1}-${w.id}`); });
            data.suspects.forEach(s => { if(s.id !== id1) cross(`${s.id}-${id2}`); });
        } else if (isSus(id1) && isLoc(id2)) {
            data.locations.forEach(l => { if(l.id !== id2) cross(`${id1}-${l.id}`); });
            data.suspects.forEach(s => { if(s.id !== id1) cross(`${s.id}-${id2}`); });
        } else if (isWea(id1) && isLoc(id2)) {
            data.locations.forEach(l => { if(l.id !== id2) cross(`${id1}-${l.id}`); });
            data.weapons.forEach(w => { if(w.id !== id1) cross(`${w.id}-${id2}`); });
        }
    },

    updateView() {
        document.querySelectorAll('.cell').forEach(td => {
            const k = td.getAttribute('data-key');
            const v = this.gridState[k] || STATE.EMPTY;
            td.setAttribute('data-state', v);
        });
    },

    attachGridEvents() {
        const table = document.getElementById('matrix-main');
        
        table.addEventListener('mousedown', (e) => {
            const cell = e.target.closest('td.cell');
            if (!cell || cell.classList.contains('spacer-cell')) return; 
            
            this.isDragging = true;
            if (this.currentTool === 'eraser') this.pushHistory();
            const key = cell.getAttribute('data-key');
            this.interactCell(key, false);
        });

        table.addEventListener('mouseover', (e) => {
            const cell = e.target.closest('td.cell');
            if (!cell || cell.classList.contains('spacer-cell')) return; 
            
            const row = cell.parentElement;
            const colIndex = cell.cellIndex;
            
            Array.from(row.children).forEach(c => {
                 if(!c.classList.contains('spacer-cell')) c.classList.add('highlight-cross');
            });
            Array.from(table.rows).forEach(r => { 
                if (r.children[colIndex] && !r.children[colIndex].classList.contains('spacer-cell')) {
                    r.children[colIndex].classList.add('highlight-cross'); 
                }
            });

            const rowHeader = row.querySelector('th');
            const colHeader = table.tHead.rows[0].cells[colIndex];

            if (rowHeader) rowHeader.classList.add('active-header');
            if (colHeader) colHeader.classList.add('active-header');

            if (this.isDragging && this.currentTool === 'eraser') {
                const key = cell.getAttribute('data-key');
                this.interactCell(key, true);
            }
        });

        table.addEventListener('mouseout', () => {
            document.querySelectorAll('.highlight-cross').forEach(el => el.classList.remove('highlight-cross'));
            document.querySelectorAll('.active-header').forEach(el => el.classList.remove('active-header'));
        });
    },

    onWin() {
        this.solvedLevels[this.idx] = true;
        this.saveGlobal();
        document.getElementById('btn-next').disabled = false;
        
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        
        const isLastLevel = this.idx >= GAME_DATA.length - 1;
        
        let btnsHtml = `<button class="btn-modal btn-secondary" onclick="game.closeModal()">ç•™åœ¨æœ¬æ¡ˆ</button>`;
        if (!isLastLevel) {
            btnsHtml += `<button class="btn-modal btn-primary" onclick="game.closeModal(); game.changeLevel(1)">ä¸‹ä¸€æ¡ˆ â–¶</button>`;
        } else {
            btnsHtml += `<button class="btn-modal btn-primary" onclick="game.closeModal()">ğŸ‰ å…¨éƒ¨é€šå…³ï¼</button>`;
        }

        document.getElementById('modal-btns').innerHTML = btnsHtml;
        this.showModal('ç ´æ¡ˆæˆåŠŸï¼', 'é€»è¾‘ä¸¥ä¸åˆç¼ï¼ŒçœŸç›¸å¤§ç™½ã€‚');
    },

    showModal(t, m) {
        document.getElementById('modal-title').innerText = t;
        document.getElementById('modal-msg').innerText = m;
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('modal').style.display = 'block';
    },
    closeModal() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('modal').style.display = 'none';
    },
    changeLevel(off) {
        this.loadLevel(this.idx + off);
    },
    
    // --- Resizers & Zoom (Fully Restored) ---
    initResizers() {
        const makeResizer = (resizerId, panelId, isLeft) => {
            const resizer = document.getElementById(resizerId);
            const panel = document.getElementById(panelId);
            if (!resizer || !panel) return;

            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                const startX = e.clientX;
                const startW = panel.offsetWidth;
                
                const onMove = (mv) => {
                    const dx = mv.clientX - startX;
                    const nw = isLeft ? startW + dx : startW - dx;
                    if(nw > 200 && nw < 800) panel.style.width = nw + 'px';
                };
                
                const onUp = () => {
                    window.removeEventListener('mousemove', onMove);
                    window.removeEventListener('mouseup', onUp);
                };
                
                window.addEventListener('mousemove', onMove);
                window.addEventListener('mouseup', onUp);
            });
        };
        makeResizer('resizer-left', 'dossier-panel', true);
        makeResizer('resizer-right', 'clue-panel', false);
    },

    initZoom() {
        const c = document.getElementById('matrix-container');
        c.addEventListener('wheel', (e) => {
            if(e.ctrlKey) {
                e.preventDefault();
                const d = e.deltaY > 0 ? -4 : 4;
                this.cellSize = Math.max(30, Math.min(80, this.cellSize + d));
                document.documentElement.style.setProperty('--cell-size', this.cellSize+'px');
            }
        }, {passive:false});
    }
};

window.onload = () => game.init();
</script>
</body>
</html>